# Домашнее задание 5

Тема: построение регрессионных моделей и анализ выживаемости.

*Выполнила Казаченко Екатерина*

## Описание ДЗ

Для выполнения первых двух заданий загрузите датасет [Breast Cancer Wisconsin](https://lms.skillfactory.ru/asset-v1:SkillFactory+MFTIBIO+SEP2023+type@asset+block@wisconsin_breast_cancer.csv).

```{r}
# импорт библиотек
library(ggplot2)
library(tidyverse)
library(car)
library(survival)
library(ggsurvfit)
library(survminer)
```

```{r}
# Загрузка и изучение типов данных датасета
cancer <- read.csv("wisconsin_breast_cancer.csv")

head(cancer)
str(cancer)
```

В колонке `diagnosis` содержится информация об опухоли (M = злокачественная, B = доброкачественная).

### Задание 1 (2 балла)

Создайте регрессионную модель, которая бы описывала связь среднего радиуса опухоли и средней площади (а), среднего периметра (б), средней симметричности (в).

Постройте графики, на которых отразите регрессионную прямую, и прокомментируйте свои находки.

```{r}
# Проверка пропущенных значений по изучаемым столбцам
colSums(is.na(cancer[c("radius_mean", "area_mean", "perimeter_mean", "symmetry_mean")]))

# пропущенных значений нет
```

В нашем случае целесообразно применить линейную регрессию, так как все переменные являются числовыми непрерывными.

Зададим уровень значимости alpha = 0.05 и гипотезы:

*Н0 - зависимая переменная и фактор не имеют статистически значимой линейной зависимости*

*Н1 - зависимая переменная и фактор имеют статистически значимую линейную зависимость*

```{r}
# построение модели линейной регрессии 
fit1 <- lm(radius_mean ~ area_mean + perimeter_mean + symmetry_mean, data = cancer) 
summary(fit1)
```

Интерпретация результатов модели:

-   Распределение остатков - Residuals - минимальное, максимальное значение, медиана, интерквартильный размах (между 1 и 3 квартилем)

-   Коэффициенты предикторов (Estimate) показывают изменение радиуса опухоли при увеличении значения предикторов на единицу.

Так, например, с увеличением средней площади и среднего периметра увеличивается и средний радиус (на 0.0007 и 0.135 соответственно), а при увеличении значения средней симметричности, средний радиус опухоли уменьшается на соответствующий коэффициент (-4.35)

-   Значение коэффициента интерсепта показывает значение радиуса опухоли при нулевом значении факторов

-   Значение `p-value` везде статистически значимое (`p-value < alpha`), то есть линейная зависимость между средним радиусом опухоли и другими факторами статистически значима.

-   Общее значение статистики `F-statistics` модели 6.511e+04

-   Общее значение `p-value` модели \< 2.2e-16

-   Остаточная стандартная ошибка модели - 0.1898

-   Скорректированныйкоэффициент детерминации (adjusted R-squared) - 0.9971 - показывает то, насколько модель предсказывает изменчивость среднего радиуса опухоли. В нашем случае, она предсказывает на 99.7%. Это может значить либо то, что мы построили отличную модель, либо то, что модель переучена из-за несоблюдения допущений и ограничений и предсказание недостоверно.

Необходимо убедиться, что соблюдаются также и требования к линейной регрессионной модели:

-   линейность зависимости факторов

```{r}
# визуальная оценка линейности зависимости зависимой переменной и одного из факторов
cancer %>%
    ggplot(aes(x = area_mean, y = radius_mean)) +
    geom_point() +
    labs(title = "Зависимость среднего радиуса и среней площади опухоли",
      x = "Средняя площадь опухоли",
      y = "Средний радиус опухоли") + 
    geom_smooth(method = "lm")
    `geom_smooth()` using formula = 'y ~ x'
```

```{r}
# визуальная оценка линейности зависимости зависимой переменной и одного из факторов
cancer %>%
    ggplot(aes(x = perimeter_mean, y = radius_mean)) +
    geom_point() +
    labs(title = "Зависимость среднего радиуса и сренего периметра опухоли",
      x = "Среднего периметра опухоли",
      y = "Средний радиус опухоли") +
    geom_smooth(method = "lm")
    `geom_smooth()` using formula = 'y ~ x'
```

```{r}
# визуальная оценка линейности зависимости зависимой переменной и одного из факторов
cancer %>%
    ggplot(aes(x = symmetry_mean, y = radius_mean)) +
    geom_point() +
    labs(title = "Зависимость среднего радиуса и среней симметричности опухоли",
      x = "Средняя симметричности опухоли",
      y = "Средний радиус опухоли") +
    geom_smooth(method = "lm")
    `geom_smooth()` using formula = 'y ~ x'
```

В целом можно сказать, что все факторы имеют линейную зависимость с зависимой переменной (средний радиус опухоли).

-   нормальное распределение остатков

```{r}
# Визуальная оценка нормальности распределения остатков
qqPlot(residuals(fit1))
```

```{r}
# Оценка нормальности распределения остатков с помощью теста Шапиро-Уилка
shapiro.test(residuals(fit1))
```

На большей части графика мы видим, что точки (осатки) несильно отклоняются и находятся в пределах обозначенных интервалов, однако в левой части графика эти отклонения сильно выражены и распространяются за пределы интервалов.

Тест Шапиро-Уилка подтверждает не нормальное распределение остатков, так как `p-value = 1.072e-11`, то есть `p-value < 0.05`, гипотезу о нормальном распределении мы не можем принять и отвергаем ее.

-   гомоскедастичность остатков

```{r}
# оценка распределения остатков 
plot(fit1, which = 1)
```

Наблюдается некоторая неравномерность распределения остатков (в одной области большая концентрация точек, в другом меньше). Для более точных результатов необходимо проводить статистические тесты.

-   отсутствие мультиколлинеарности - независимые переменные не должны коррелировать друг с другом.

Построим графиики распределения независимых переменных попарно друг с другом

```{r}
cancer %>%
    ggplot(aes(x = area_mean, y = perimeter_mean)) +
    geom_point() +
    labs(title = "Зависимость средней площади и сренего периметра опухоли",
      x = "Средняя площадь опухоли",
      y = "Средний периметр опухоли")
```

```{r}
cancer %>%
    ggplot(aes(x = area_mean, y = symmetry_mean)) +
    geom_point() +
    labs(title = "Зависимость средней площади и сренеей симметричности опухоли",
      x = "Средняя площадь опухоли",
      y = "Средняя симметричность опухоли") 
```

```{r}
cancer %>%
    ggplot(aes(x = perimeter_mean, y = symmetry_mean)) +
    geom_point() +
    labs(title = "Зависимость среднего периметра и сренеей симметричности опухоли",
      x = "Средней симметричности опухоли",
      y = "Средний периметр опухоли")
```

По графику мы видим, что есть сильная линейная зависимость между признаками средняя площадь и средний периметр. Для нашей модели это может значить то, что данные признаки сильно коррелируют друг с другом, это дает явление мультиколлинеарности и ухудшает результат модели. Поэтому для построения грамотной хорошей модели нужно убрать один из этих признаков, например, средний периметр опухоли.

Также в связи с наличием гетескедастичности можно подумать о преобразовании или переопределении зависимой переменной, а также использовать взвешенную регрессию.

-   Еще одно требование для линейной регрессии у нас соблюдается - наблюдения в нашем датасете независимые, так как представлены отдельными не связанными друг с другом наблюдениями.

### Задание 2 (2 балла)

Пусть колонка с диагнозом принимает следующие значения: злокачественная опухоль — 1, а доброкачественная — 0. Постройте модель, которая бы прогнозировала вероятность возникновения злокачественной опухоли от среднего радиуса (а), средней площади (б), средней текстуры (в).

Постройте графики. Создайте модель, которая бы прогнозировала вероятность возникновения злокачественной опухоли от всех трех перечисленных факторов.

```{r}
# Преобразование столбца с диагнозом
cancer$diagnosis <- ifelse(cancer$diagnosis == 'M', 1, 0)

# проверка
head(select(cancer, diagnosis),10)
```

Зададим уровень значимости alpha = 0.05 и гипотезы:

*Н0 - зависимая переменная и фактор не имеют статистически значимой зависимости*

*Н1 - зависимая переменная и фактор имеют статистически значимую зависимость*

В данном случае целесообразно построить модель логистической ререссии, так как зависимая переменная - бинарная категориальная (две категории опухоли). Наблюдения в нашем датасете независимые, так как представлены отдельными не связанными друг с другом наблюдениями.

```{r}
# модель логистической регрессии
gfit1 <-
  glm(diagnosis ~ radius_mean + area_mean + texture_mean, data = cancer, family = "binomial")
summary(gfit1)
```

Интерпретация результатов модели:

-   В интерсепт заложено значение логарифм отношения шансов исхода в виде наличия доброкачественной опухоли (так как она имеет значение 0), когда все предикторы равны 0. Отрицательное значение указывает на то, что при нулевых значениях предикторов, вероятность диагностирования злокачественной опухоли (которая закодирована как **`1`**) выше, чем доброкачественной. С увеличением среднего радиуса шансы на диагностирование доброкачественной опухоли уменьшаются, то есть увеличивается шанс диагностирования злокачественной опухоли. Между средней площадью и шансом диагностирования доброкачественной опухоли имеется положительная связь, также как и для фактора - среднее значение текстуры опухоли.

-   Значение `p-value` для признаков сренего радиуса и средней площади статистически незначимое (`p-value > alpha`), то есть та связь, которая отражена в коэффициентах для этих признаков, статистически не достоверна. Для признака текстуры опухоли `p-value < alpha`, следовательно этот признак статистически достоверно отражает взаимосвязь фактора и зависимой переменной (тип опухоли).

-   остаточное отклонение — Deviance Residuals - 288.81 для 565 степеней свободы

-   нулевое отклонение — Null - 751.44 для 565 степеней свободы

Для более понятной интерпретации необходимо сделать следующее преобразование коэффициентов модели:

```{r}
exp(coefficients(gfit1))
```

Таким образом, мы можем сказать, что при диагностировании доброкачественной опухоли в отличие от злокачественной признак средней текстуры опухоли будет больше в 1.23 раз, такая разница является достоверной. Зависимость других факторов и типа опухоли статистически незначимо.

Логистическая регрессия также имеет свои требования и допущения, которые в данном случае проверяться не будут, так как это не указано отдельно в задании.

-   мультиколлинеарность факторов

-   линейная связь между факторами и логитом зависимой переменной

-   отсутствие экстремальных выбросов

```{r}
# визуализация кривой логистической регрессии для зависимой переменной и одного из факторов
cancer %>%
    ggplot(aes(x = radius_mean, y = diagnosis)) +
    geom_point() +
    labs(title = "Зависимость типа опухоли и сренего радиуса опухоли",
      x = "Средний радиус опухоли",
      y = "Тип опухоли") +
    geom_smooth(method = "glm", 
                method.args = list(family = "binomial")) +
  theme_bw()
```

```{r}
# визуализация кривой логистической регрессии для зависимой переменной и одного из факторов
cancer %>%
    ggplot(aes(x = area_mean, y = diagnosis)) +
    geom_point() +
    labs(title = "Зависимость типа опухоли и среней площади опухоли",
      x = "Средняя площадь опухоли",
      y = "Тип опухоли") +
    geom_smooth(method = "glm", 
                method.args = list(family = "binomial")) +
  theme_bw()
```

```{r}
# визуализация кривой логистической регрессии для зависимой переменной и одного из факторов
cancer %>%
    ggplot(aes(x = texture_mean, y = diagnosis)) +
    geom_point() +
    labs(title = "Зависимость типа опухоли и сренего значения текстуры опухоли",
      x = "Средняя текстура опухоли",
      y = "Тип опухоли") +
    geom_smooth(method = "glm", 
                method.args = list(family = "binomial")) +
  theme_bw()
```

Логистическая регрессионная модель, отражающая прогноз вероятности возникновения злокачественной опухоли от всех трех перечисленных факторов при их взаимодействии.

```{r}
gfit2 <-
  glm(diagnosis ~ radius_mean * area_mean * texture_mean,
      data = cancer,
      family = "binomial")

summary(gfit2)
```

По результатам логистической регрессии с взаимодействием всех 3 факторов, мы видим, что влияние на зависимую переменную при взаимодействии всех факторов статистически не значимо, так как `p-value > alpha`.

### Задание 3 (6 балла)

Для выполнения этого задания вам понадобится датасет lung, который встроен в пакет survival. Установите этот пакет и загрузите датасет.

```{r}
lung <- survival::lung
head(lung)
```

Датасет содержит следующий набор переменных:

-   inst: код учреждения;
-   time: время выживаемости в днях;
-   status: 1 = цензурирование, 2 = смерть;
-   age: возраст в годах;
-   sex: мужской = 1, женский = 2;
-   ph.ecog: шкала опросника ECOG (оценку проводит врач). 0 = отсутствие симптомов, 1= симптомы есть, но пациент наблюдается амбулаторно, 2 = меньше половины дня пациент вынужден проводить в постели, 3 = больше половины дня нуждается в отдыхе лежа, но не прикован к постели, 4 = прикован к постели;
-   ph.karno: шкала Карновского (от 0 до 100, от худшего к лучшему) по оценке врача;
-   pat.karno: шкала Карновского (от 0 до 100, от худшего к лучшему) по оценке пациента;
-   meal.cal: калории потребляемой пищи;
-   wt.loss: потеря веса за последние полгода.

Создайте переменную event, в которой отразите наличие или отсутствие (1 или 0) интересующего события — смерти пациента.

```{r}
lung$event <- ifelse(lung$status == 2,1,0)
head(lung)
```

```{r}
# делаем выборку только тех пациентов, которые достигли целевого события (смерть)
lung_2 <- filter(lung,lung$event == 1)
head(lung_2)
```

Изучите работу функций Surv(), survfit() и ggsurvplot():

-   Постройте кривые выживаемости в зависимости от пола (на одном графике должны получиться две кривые для каждого пола и таблица числа пациентов, подверженных риску (at risk) под ним). Поясните получившееся значение p-value для лог-рангового теста и опишите наблюдаемые результаты.

```{r}
# График кривых выживаемости в зависимости от пола
surv_fit <- survfit(Surv(time, status) ~ sex, data = lung_2)

ggsurvplot(surv_fit, conf.int = TRUE, surv.median.line = 'hv', risk.table = TRUE)
```

На графике кривых выживаемости по оси x отложено время, а по оси y - доля выживших пациентов, что показывает, как изменяется доля выживших в зависимости от времени.

На графике мы видим, что доверительные интервалы двух групп пересекаются, линии графика также пересекаются. Это может говорить об отсутсвии значимых различий между группами по выживаемости.

Зададим уровень значимости, alpha = 0.05

Н0 - Разница в выживаемости между двумя группами отсутствует.

Н1 - Существует разница в выживаемости между двумя группами, разделенными по полу.

```{r}
# Лог-ранг тест
survdiff(Surv(time, status) ~ sex, data = lung_2)
```

Мы видим две строки, соответсвующие группам, разделенным по полу. В столбце N обозначено общее количество человек в группе, столбцы Observed и Expected - наблюдаемые и ожидаемые события.

`P-value = 0.1`, то есть `p-value > alpha` =\> мы не можем отвергнуть нулевую гипотезу и принимаем ее - нет статистически значимой разницы в выживаемости между двумя группами, разделенными по полу.

-   Постройте график кумулятивной функции рисков (cumulative hazard function) для пола. Проинтерпретируйте график.

```{r}
# График кумулятивной функции рисков по полу
ggsurvplot(surv_fit, fun = "cumhaz", conf.int = TRUE, risk.table = TRUE)
```

На графике кумулятивной функции рисков по оси x отложено время, а по оси y - риск целевых событий, что показывает, как изменяется риск в зависимости от времени.

На графике мы видим, что доверительные интервалы двух групп пересекаются, линии графика также пересекаются. Это может говорить об отсутсвии значимых различий между полом по уровню риска.

-   С помощью функции coxph() постройте регрессию Кокса и оцените влияние пола на выживаемость. Что вы можете сказать о полученных результатах?

```{r}
# регрессия Кокса
cox <- coxph(Surv(time, status) ~ sex, data = lung_2)
summary(cox)
```

По результатам мы видим `p-value = 0.136`, то есть разница между двумя группами по полу статистически незначима, так `p-value > alpha.`

Также можем оценить различие в риске у двух групп по полу по величине коэффициента (coef) и экспоненты коэффициента (exp(coef)). В нашем случае уровень относительного риска (exp(coef)) 0.7779.

```{r}
# Выполнение преобразования exp(coef) и exp(-coef)
(1 - 0.7779) * 100 
(1 - 1.285) * 100 
```

То есть риск смерти в группе женщин ниже, чем у мужчин на 22.21%, а риск смерти в группе мужчин выше на 28.5%. Однако, мы знаем, что эти различия по результатам регрессии Кокса не достоверны.

Тесты Likelihood ratio и Wald test также подтсверждают то, что наши результаты не имеют статистически значимой разницы.

Таким образом, мы провели анализ только на тех пациентах, которые достигли целевого события (смерть). Это не совсем правильный подход в оценке выживаемости и риска. Как видно, в данном случае мы не получили никаких статистически значимых ращличий между группами ни по выживаемости, ни по риску, хотя на самом деле при учете цензурирования и всех пациентов датасета эти различия есть.