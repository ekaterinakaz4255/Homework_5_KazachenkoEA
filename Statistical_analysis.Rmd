# Статистический анализ и проверка гипотез

## Задание 1

Рассмотрите следующую статистическую гипотезу.

-   Проводят некоторое исследование пациентов с артериальной гипертензией. Предположим, что внедрение нового препарата в среднем лучше снижает их давление по сравнению со стандартной терапией.

-   Задайте `seed` для воспроизводимости результатов (функция `set.seed()`). Задайте размер выборки `sample_size <- 30`. Задайте значение среднего артериального давления до приема нового препарата и после.

```{r}
# импорт библиотек
library(ggplot2)
library(tidyverse)
library(car)
```

```{r}
# Задаем seed
set.seed(12)

# Размер выборки
sample_size <- 30

# Среднее систолическое артериальное давление до и после приема препарата
mean_pressure_before <- 145  
mean_pressure_after <- 125  

# Генерируем данные из нормального распределения с заданным стандартным отклонением
sd_pressure <- 14
pressure_before <- rnorm(sample_size, mean_pressure_before, sd_pressure)

# Стандартное отклонение во второй выборке
sd_pressure_after <- 8
pressure_after <- rnorm(sample_size, mean_pressure_after, sd_pressure_after)

# Объединяем в один датасет
pressure <- data.frame(Pressure_Before = pressure_before,
                            Pressure_After = pressure_after)
# Смотрим на результат
head(pressure)
```

Затем:

-   Сформулируйте нулевую и альтернативную гипотезы.

`H0 (нулевая гипотеза) - артериальное давление до и после приема препарата статистически значимо не отличаются`

`H1 (альтернативная гипотеза) - есть статистически значимая разница между артериальным давлением до и после приема препарата`

-   Определите уровень значимости.

Зададим уровень значимости, например, 0.05:

$$
\alpha = 0.05
$$

-   Выберите статистический тест для проверки гипотезы и аргументируйте свой выбор.

Перед выбором статистического теста нам обычно необходимо знать распределение данных. Распределение данных можно оценить визуально и с помощью статистических тестов.

```{r}
# визуальная оценка распределения артериального давления до приема препарата

ggplot(pressure, aes(x = Pressure_Before)) +
  geom_histogram(binwidth = 5,fill = "lightgreen", color = "black") +
  labs(title = "Гистограмма распределения артериального давления до приема препарата", x = "Значения", y = "Частота") +
  theme_minimal()
# можно сказать, распределение визуально имеет признаки нормального, хотя оно не идеально нормальное
```

```{r}
# визуальная оценка распределения артериального давления после приема препарата

ggplot(pressure, aes(x = Pressure_After)) +
  geom_histogram(binwidth = 3, fill = "lightblue", color = "black") +
  labs(title = "Гистограмма распределения артериального давления после приема препарата", x = "Значения", y = "Частота") +
  theme_minimal()
# распределение не очень похоже на нормальное 
```

```{r}
# тест Шапиро-Уилка на нормальность распределения
# H0 - распределение нормальное
# H1 - распределение отлично от нормального
# alpha = 0.05
shapiro.test(pressure$Pressure_Before)
shapiro.test(pressure$Pressure_After)
```

`p-value = 0.7715` для Pressure_Before

`p-value = 0.2432` для Pressure_After

Так как в обоих случаях `p-value > alpha`, то мы не можем отвергнуть Н0 и принмаем ее =\> распределение в обеих выборках нормальное.

Для поиска статистически значимых различий в данном случае можно применить парный t-test, так как данные распределены нормально, анализируемая переменная - количественная, сравнение 2 зависимых выборок (одни и те же пациенты до и после лечения):

```{r}
# определяем средние значения для каждой выборки
mean(pressure$Pressure_Before)
mean(pressure$Pressure_After)
# проводим парный t-test
t.test(pressure$Pressure_Before, pressure$Pressure_After, paired = TRUE)
```

-   Определите наблюдаемое значение статистики, а также критическое значение статистики.

```{r}
# Расчет критического значения для нормального распределения, где степени свободы = 29 и alpha = 0.05
alpha = 0.05
qt(1 - alpha/2, df = 29)
```

`p-value = 1.531e-08`

Также по полученным результатам t-test можем оценить 95% доверительный интервал, где находится разность средних значений 2 выборок \[13.42 - 23.05\] и среднюю разницу между значениями - 18.23, количество степеней свободы - 29, значение t-статистики 7.75, что и есть наблюдаемое значение для нашей выборки.

По результатам наблюдаемое значение статистики (7.75) значительно превышает критическое значение 2.045 для 29 степеней свободы на уровне значимости 0.05.

-   Оцените и прокомментируйте статистическую значимость.

`p-value < alpha`, следовательно мы отвергаем Н0 и принимаем Н1 =\> есть статистически значимая разница между артериальным давлением до и после приема препарата. Следовательно, наш препарат эффективен в снижении систолического артериального давления.

95% доверительный интервал не включает ноль, что подтверждает значимость различия средних.

## Задание 2

Рассмотрите следующую статистическую гипотезу.

-   Существует некоторая связь между курением и развитием рака легких. Пусть у курящих людей вероятность заболеть раком легких составляет 0.8, а у некурящих — 0.2

-   Рассмотрите два случая: для выборки `sample_size1 <- 100` и выборки `sample_size2 <- 30`. Сгенерируйте данные по курению с помощью функции `rep()`, пусть отношение числа курящих к некурящим в каждой выборке составляет 1:1.

```{r}
# Размер первой выбороки
sample_size1 <- 100

# Создаем вектор курящих (1) и некурящих (0)
smoking_status <- rep(c(1, 0), each = (sample_size1 / 2))

# Генерируем данные для рака легких с заданной вероятностью
set.seed(13) 
cancer_and_smoker <- rbinom((sample_size1 / 2), 1, 0.8)
cancer_and_nonsmoker <- rbinom((sample_size1 / 2), 1, 0.2)

# Объединяем данные рака легких для курящих и некурящих
lung_cancer <- c(cancer_and_smoker, cancer_and_nonsmoker)

# Создаем фрейм данных
sample100 <- data.frame(Smoking = smoking_status,
                        LungCancer = lung_cancer)

# Смотрим результат
head(sample100)
```

```{r}
# Размер второй выбороки
sample_size2 <- 30

# Создаем вектор курящих (1) и некурящих (0)
smoking_status <- rep(c(1, 0), each = (sample_size2 / 2))

# Генерируем данные для рака легких с заданной вероятностью
set.seed(1) 
cancer_and_smoker <- rbinom((sample_size2 / 2), 1, 0.8)
cancer_and_nonsmoker <- rbinom((sample_size2 / 2), 1, 0.2)

# Объединяем данные рака легких для курящих и некурящих
lung_cancer <- c(cancer_and_smoker, cancer_and_nonsmoker)

# Создаем фрейм данных
sample30 <- data.frame(Smoking = smoking_status,
                        LungCancer = lung_cancer)

# Смотрим результат
head(sample30)
```

Затем:

-   Сформулируйте нулевую и альтернативную гипотезы.

`H0 (нулевая гипотеза) - вероятность развития рака легких в обеих группах (курящие и некурящие) одинакова (статистически незначимая разница)`

`H1 (альтернативная гипотеза) - в группе курящих риск развития рака легких статистически значимо выше, чем в группе некурящих.`

-   Определите уровень значимости.

Зададим уровень значимости, например, 0.05:

$$ \alpha = 0.05 $$

-   Выберите статистический тест для проверки гипотезы и аргументируйте свой выбор.

```{r}
# Построение столбчатой диаграммы для первой выборки
barplot(table(sample100$Smoking, sample100$LungCancer), beside = TRUE,
        col = c("blue", "red"), legend = c("Нет рака легких", "Рак легких"),
        names.arg = c("Некурящие", "Курящие"), main = "Рак легких среди курящих и некурящих людей (выборка 100)",
        ylab = "Количество наблюдений")
```

```{r}
# Построение столбчатой диаграммы для второй выборки
barplot(table(sample30$Smoking, sample30$LungCancer), beside = TRUE,
        col = c("blue", "red"), legend = c("Нет рака легких", "Рак легких"),
        names.arg = c("Некурящие", "Курящие"), main = "Рак легких среди курящих и некурящих людей (выборка 30)",
        ylab = "Количество наблюдений")
```

В нашем случае мы видим следующее:

-   в обеих выборках событие (рак легких) распределено между выборками курящих и некурящих неравномерно по условию задачи.

-   переменные обе категориальные

-   наблюдения независимые между собой

-   также в выборке с размером 30 наблюдений мы видим по графику, что в группе некурящих рак легких встречается только в 3 наблюдениях, также как и в группе курящих количество наблюдений без рака легких.

На основании этого выбираем точный тест Фишера.

```{r}
# Статистический тест для проверки гипотез на выбрке со 100 наблюдениями
# Таблица сопряженности для курящих и некурящих
contingency_table100 <- table(sample100$Smoking, sample100$LungCancer)

# Применяем точный тест Фишера
# в соответствии с формулировкой альтернативной гипотезы выбираем alternative = "greater" - одностороняя гипотеза
fisher_test_result100 <- fisher.test(contingency_table100, alternative = "greater")

# Выводим результаты теста
fisher_test_result100
```

```{r}
# Аналогично провдим тест для выборки с 30 наблюдениями
contingency_table30 <- table(sample30$Smoking, sample30$LungCancer)

fisher_test_result30 <- fisher.test(contingency_table30, alternative = "greater")

fisher_test_result30
```

-   Определите наблюдаемое значение статистики, а также критическое значение статистики.

Для точного теста Фишера неприменимы понятия наблюдаемое значение статистики и критическое значение статистики, так как в этом тесте происходит сразу расчет значения `p-value` на основе таблицы сопряженности, на основе которой рассчитываются частоты тех или иных событий, а из частот рассчитывается `p-value.`

Формула расчета `p-value` для точного теста Фишера:

$$
p= \frac{(a+b)!×(c+d)!×(a+c)!×(b+d)}{!a!×b!×c!×d!×n!}
$$

где *a, b, c, d* - число событий для каждой категории для таблицы сопряженности 2х2

Помимо этого, тест также рассчитывает Odds ratio - отношение шансов наступления события в одной группе к шансам наступления того же события в другой группе. 

Для выборки со 100 наблюдениями:

`p-value = 1.066e-09`

`95% доверительный интервал : [6.334827 - бесконечность]`

`Отношение шансов 15.552`

Для выборки с 30 наблюдениями:

`p-value = 0.001407`

`95% доверительный интервал : [2.660628 - бесконечность]`

`Отношение шансов 14.11256`

-   Оцените и прокомментируйте статистическую значимость.

В обоих случаях мы получили, что `p-value < alpha`, следовательно мы отвергаем Н0 и принимаем Н1 =\> в группе курящих риск развития рака легких статистически значимо выше, чем в группе некурящих. Отношение шансов указывает на то, что вероятность развития рака легких в группе курящих выше в 15,6 и 14 раз в выборках со 100 и 30 наблюдениями соответственно.

## Задание 3

Рассмотрите следующую статистическую гипотезу.

-   Применение нового метода лечения синдрома раздраженного кишечника значимо меняет уровень болевых симптомов по сравнению с группой, прошедшей лечение диетотерапией.

-   Исследователь избегает любых допущений, кроме того, что выборки независимы и имеют одинаковое распределение.

```{r}
set.seed(42)
sample_size <- 50

# Средние и стандартные отклонения для каждой группы
mean_new_treatment <- 4
sd_new_treatment <- 2
mean_diet_therapy <- 6
sd_diet_therapy <- 2

# Генерируем выборки
new_treatment_group <- round(rnorm(sample_size, mean_new_treatment, sd_new_treatment))
diet_therapy_group <- round(rnorm(sample_size, mean_diet_therapy, sd_diet_therapy))

# Объединяем в один датасет
treatment <- data.frame(New_method = new_treatment_group,
                            Dietotherapy = diet_therapy_group)
# Смотрим на результат
head(treatment)
```

Что нужно сделать:

-   Сформулируйте нулевую и альтернативную гипотезы.

`H0 (нулевая гипотеза) - нет статистически значимых различий между эффективностью лечения новым методом и диетотерапией.`

`H1 (альтернативная гипотеза) - Есть статистически значимые различия между эффективностью лечения новым методом и диетотерапией.`

-   Определите уровень значимости.

Зададим уровень значимости, например, 0.05:

$$ \alpha = 0.05 $$

-   Выберите статистический тест для проверки гипотезы и аргументируйте свой выбор.

Перед выбором статистического теста необходимо знать распределение данных. Оценим это визуально и с помощью статистических тестов.

```{r}
# визуальная оценка распределения уровня боли при использовании нового метода лечения  

ggplot(treatment, aes(x = New_method)) + 
            geom_histogram(binwidth = 1,fill = "99FF99", color = "black") + 
            labs(title = "Гистограмма распределения уровня боли при использовании нового метода лечения", x = "Уровень боли", y = "Частота") + 
            theme_minimal() 
# распределение не похоже на нормальное
```

```{r}
# визуальная оценка распределения уровня боли при использовании диетотерапии 

ggplot(treatment, aes(x = Dietotherapy)) + 
            geom_histogram(binwidth = 1,fill = "66FFFF", color = "black") + 
            labs(title = "Гистограмма распределения уровня боли при использовании диетотерапии", x = "Уровень боли", y = "Частота") + 
            theme_minimal() 
# распределение не похоже на нормальное
```

```{r}
# тест Шапиро-Уилка на нормальность распределения 
# H0 - распределение нормальное 
# H1 - распределение отлично от нормального 
# alpha = 0.05

shapiro.test(treatment$New_method) 
shapiro.test(treatment$Dietotherapy)
```

`p-value = 0.1888` для уровня боли при использовании нового метода лечения

`p-value = 0.002487` для уровня боли при использовании диетотерапии

В первой выборке `p-value > alpha`, мы не можем отвергнуть Н0 и принмаем ее =\> распределение в этой выборке нормальное. Однако во второй выборке `p-value < alpha`, мы не можем принять Н0 и принмаем Н1 =\> распределение в этой выборке ненормальное.

Таким образом, для поиска статистически значимых различий в данном случае мы выбираем непараметрический статистический тест Манна-Уитни, так как анализируемая переменная - уровень боли - дискретная, одна из выборок имеет ненормальное распределение по результату теста Шапиро-Уилка, также мы сравниваем здесь 2 независимые выборки. Объем выборок достаточный для проведеения теста.

```{r}
# определяем средние значения для каждой выборки
mean(treatment$New_method)
mean(treatment$Dietotherapy)

# Проводим двухвыборочный двусторониий тест Манна-Уитни
wilcox.test(treatment$New_method, treatment$Dietotherapy)
```

-   Определите наблюдаемое значение статистики, а также критическое значение статистики.

```{r}
# Расчет критических значений статистики 
alpha = 0.05
sample_size = 50
# Расчет нижней границы
lower_critical <- qwilcox(alpha / 2, sample_size, sample_size, lower.tail = TRUE)
print(lower_critical)

# Расчет верхней границы
upper_critical <- qwilcox(1 - alpha / 2, sample_size, sample_size, lower.tail = TRUE)
print(upper_critical)
```

По результатам наблюдаемое значение статистики (W=545) не входит в границы рассчитанного интервала критических значений статистики (966, 1534) для уровня значимости 0.05.

Мы получили следующие данные:

-   среднее значение уровня боли в выборке New_method - 3.9

-   среднее значение уровня боли в выборке Dietotherapy - 6.24

-   Значение статистики W = 545

-   `p-value = 9.415e-07`

-   Оцените и прокомментируйте статистическую значимость.

`p-value < alpha`, поэтому мы отвергаем Н0 и принимаем Н1 =\> Есть статистически значимые различия между эффективностью лечения новым методом и диетотерапией. Так как тест двусторонний, то по идее мы не знаем, какая выборка больше или меньше, мы знаем, что между ними есть разница. Однако, мы можем сделать заключение, какой метод лечения действительно эффективнее снижает боль, по рассчитанным медианам. Медиана уровня боли ниже в группе New_method.

Следовательно, новый метод лечения статистически значимо снижает уровень боли в отличие от диетотерапии.

## Задание 4

Рассмотрите следующую гипотезу.

-   Проводится исследование, в котором исследуются три противоопухолевые препарата A, B, плацебо (0) на трех группах мышей. В каждой из трех групп по 10 мышей.  Оценивается размер опухоли у мыши.

Сгенерируйте датсет следующим образом:

```{r}
tumor <- tibble(
  therapy = c(rep("0", 10), rep("A", 10), rep("B", 10)),
  value = c(rep(3213, 10), rep(2687, 10), rep(2423, 10))
) %>%
  mutate(therapy = factor(therapy, levels = c("0", "A", "B")))

tumor$value <- tumor$value + rnorm(30, 0, 760)
```

-   Постройте на одном графике три ящика с усами для наглядности.

```{r}
# Боксплот для 3 категорий терапии мышей
ggplot(tumor, aes(x = therapy, y = value, fill = therapy)) +
  geom_boxplot() +
  labs(title = "Боксплот распределения значений размера опухоли у мышей в зависимости от выбранного вида лечения", x = "Вид лечения", y = "Размер опухоли") +
  theme_minimal()
```

-   Проведите дисперсионный анализ, чтобы выяснить, есть ли разница между размером опухоли во всех группах.

В данном случае мы действительно можем применить дисперсионный анализ, так хотим найти разницу в количественных данных, разделенных по категориям. Для этого теста мы также должны быть уверены, что данные во всех группах распределены нормально и соблюдено требование гомоскедастичности (равность дисперсий групп).

Во всех группах у нас равное количество наблюдений, выборки независимы, выбросов нет.

```{r}
# Визуальная оценка распределений значений в 3 выборках
tumor %>%
    ggplot(aes(value, fill = therapy)) +
    geom_density(alpha = 0.5) +
    labs(title = "График распределения значений размера опухоли у мышей в зависимости от выбранного вида лечения", x = "Размер опухоли", y = "Распределение") + 
    theme_bw()
```

```{r}
# тест Шапиро-Уилка на нормальность распределения 
# H0 - распределение нормальное 
# H1 - распределение отлично от нормального 
# alpha = 0.05

shapiro.test(tumor$value[tumor$therapy == 0])
shapiro.test(tumor$value[tumor$therapy == 'A'])
shapiro.test(tumor$value[tumor$therapy == 'B'])
```

`p-value = 0.677` для первой выборки

`p-value = 0.02433` для второй выборки

`p-value = 0.5381` для второй выборки

В первой и третьей выборке `p-value > alpha`, мы не можем отвергнуть Н0 и принмаем ее =\> распределение в этих выборке нормальное. Однако во второй выборке `p-value < alpha`, мы не можем принять Н0 и принмаем Н1 =\> распределение в этой выборке ненормальное.

```{r}
# Проверка гомогенности дисперсий с помощью теста Левена
# H0 - дисперсии гомогенны 
# H1 - дисперсии негомогенны 
# alpha = 0.05
leveneTest(value ~ therapy, data = tumor)
```

`p-value = 0.9757 - дисперсии в 3 выборках гомогенны`

Так как у нас в одной из групп распрделение ненормальное, то выбираем дисперсионный анализ Краскела-Уоллиса для непараметрических данных

```{r}
kruskal_test = kruskal.test(value ~ therapy, data = tumor)
kruskal_test
```

-   Прокомментируйте получившийся результат.

Допустим, у нас были следующие гипотезы:

`H0 (нулевая гипотеза) - нет статистически значимых различий между размером опухоли в 3 выборках.`

`H1 (альтернативная гипотеза) - Есть статистически значимые различия между размером опухоли в 3 выборках.`

`alpha = 0.05`

Результат дисперсионного анализа (тест Краскела-Уоллиса):

`p-value = 0.0003537`

Также по полученным результатам теста можем количество степеней свободы - 2, chi-squared = 15.894 - так как данный тест основан на распределении X-квадрат, то здесь также рассчитывается такая статистика.

Таким образом, `p-value < alpha`, мы не можем принять Н0 и отвергаем ее =\> принимаем `H1 (альтернативная гипотеза) - Есть статистически значимые различия между размером опухоли в 3 выборках.`

-   С помощью функции TukeyHSD() проведите попарные сравнения, используя критерий Тьюки.

Апостериорный тест Тьюки обычно используется после дисперсионного анализа ANNOVA для поиска попарных различий между сравниваемыми группами. Поэтому проведем дисперсионный тест ANNOVA (хотя у нас есть одна выборка с ненормальным распределением)

```{r}
# Дисперсионный анализ ANNOVA
aov_model <- aov(value ~ therapy, data = tumor)
summary(aov_model)
```

```{r}
# Тест Тьюки
tukey_results <- TukeyHSD(aov_model, confV.level = 0.95)
print(tukey_results)
```

-   Прокомментируйте полученные результаты.

В дисперсионном анализе ANNOVA мы получили следующее:

-   p-value 0.000232

-   Количество степеней свободы - 2

-   Сумма квадратов при межгрупповом сравнении - 12329307

-   Среднее квадратичное значение при межгрупповом сравнении - 6164653

-   Значение F-статистики - 11.59

Здесь у нас были аналогичные гипотезы и такой же уровень значимости alpha. По результатам теста `p-value < alpha`, мы не можем принять Н0 и отвергаем ее =\> принимаем `H1 (альтернативная гипотеза) - Есть статистически значимые различия между размером опухоли в 3 выборках.`

Результаты теста Тьюки:

-   Мы видим сравнение всех 3 групп попарно в каждой строке и для каждого сравнения есть `p-adjusted` - измененное `p-value` для множественных сравнений.

Значения `p-adjusted` для всех сравнений:

-   Для группы A-0 - 0.0375948

-   Для группы B-0 - 0.0001463

-   Для группы В-А - 0.0893889

Таким образом, при сравнении групп A-0 и B-0 `p-adjusted < alpha`, мы не можем принять нулевую гипотезу (отвергаем), то есть принимаем альтернативную гипотезу, в этих группах есть статистически значимая разница, а при сравнении групп В-А `p-adjusted > alpha`, то есть мы не можем отвергнуть нулевую гипотезу, статистически значимой разницы нет.

Так, по результатам теста сравнения размера опухоли у мышей в 3 группах лечения, мы получили, что нет статистически занчимых различий между группами А и В, при этом группа плацебо (0) имеет различия при сравнении с другими двумя группами.