# Расчет выборки при планировании исследования.

Цель: научиться рассчитывать выборку для исследований с различными конечными точками.

## Описание

При выполнении задания вам необходимо посчитать выборки для различных типов точек. Напишите соответствующий код, пользуясь указанными формулами.

Пусть наш спонсор заинтересован, чтобы исследование имело **80% мощность**, а **уровень значимости — 5%**, ожидаемый **drop-out rate = 10%.**

```{r}
# импорт библиотек
library(tidyverse)
library(TrialSize)
```

```{r}
# Задаем указанные параметры для дальнейших расчетов
power = 0.8
beta = 1 - power
alpha = 0.05
drop_out_rate = 0.1
```

### **Что нужно сделать:**

1.  Рассчитайте выборку для исследования терапевтической эквивалентности для двухпериодного cross-over дизайна. Из предыдущих исследований известно, что дисперсия составляет 20% (σm = 0.20), а разница средних составляет −10% (ε=μtest −μreference ). Клиницисты сообщают нам, что клинически значимая разница составляет 25% (δ = 0.25).

*Воспользуйтесь следующей формулой:*

$$
n1 = n2 = \frac{(Z_{{\alpha}}+Z_\frac{\beta}{2})^2\sigma^2_m}{2*(\delta-|\epsilon|)^2} , n = n_1 + n_2
$$

```{r}
# Задаем указанные параметры для дальнейших расчетов
sigma = 0.2
e = -0.1
delta = 0.25
Za <- abs(qnorm(1 - alpha, lower.tail = FALSE))
Zb <- abs(qnorm(1 - beta/2))
```

```{r}
# Расчет объема выборки для одной группы
n1 = ceiling(
    ((Za + Zb)**2 * sigma^2)/(2 * (delta - abs(e))^2)
)
print(n1)
```

```{r}
# Общий объем выборки для обеих групп
n = n1*2
print(n)
```

```{r}
# Расчет объема выборки с учетом drop-out rate
n_new = ceiling(
    n/(1-drop_out_rate)
)
print(n_new)
```

Финальный общий объем выборки - 18 человек, по 9 человек в каждой группе

```{r}
# Проверим с помощью библиотеки TrialSize
trial_size_n1 <- TwoSampleCrossOver.Equivalence(alpha, beta, sigma, delta, e)
trial_size_n = ceiling(trial_size_n1) * 2
trial_size_n = trial_size_n/(1 - drop_out_rate)
ceiling(trial_size_n)
```

При использовании [библиотеки TrialSize для расчета объема выборки для двухвыборочного cross-over исследования эквивалентности](https://rdrr.io/cran/TrialSize/src/R/TwoSampleCrossOver.Equivalence.R "TwoSampleCrossOver.Equivalence.R") мы рассчитали общий объем выборки с учетом непредвиденного 10%-ого выбытия пациентов - 18 человек - аналогичный результат с нашими расчетами по формуле.

2.  Рассчитайте выборку для гипотезы non-inferiority для двухвыборочного параллельного дизайна. Пусть клинически значимая разница δ = -0.1, то есть мы ожидаем разницу не меньше 10%, а долю ответов для тестового препарата p2 = 0.65, в то время как нам известно из предыдущих исследований, что доля ответов у препарата сравнения составляет p1 = 0.85. Соотношение групп равно k = 1.

*Воспользуйтесь следующей формулой:*

$$
n1 = n2 = \frac{(Z_{\frac{\alpha}{2}}+Z_{\beta})^2(p^*_1(1-p_1)+p^*_2(1-p_2))}{(p_1-p_2-\delta)^2} , n = n_1 + n_2
$$

```{r}
# Задаем указанные параметры для дальнейших расчетов
delta = -0.1
p1 = 0.85
p2 = 0.65
k = 1
Za <- abs(qnorm(alpha / 2, lower.tail = FALSE))
Zb <- abs(qnorm(beta))
```

```{r}
# Расчет оюъема выборки для одной группы
n1 = ceiling(
    ((Za + Zb)^2 * (p1*(1-p1) + p2*(1-p2))) / (p1 - p2 - delta)^2
)
print(n1)
```

```{r}
# Общий объем выборки для обеих групп
n = n1*2
print(n)
```

```{r}
# Расчет объема выборки с учетом drop-out rate
n_new = ceiling(
    n/(1-drop_out_rate)
)
print(n_new)
```

Рассчетный общий объем выборки - 69 человек. Для более корректного разделения на 2 группы в дальнейшем возьмем 70 человек - по 35 в каждой группе.

```{r}
# Проверим с помощью библиотеки TrialSize
margin = p1 - p2
trial_size_n1 <- TwoSampleProportion.NIS(alpha=0.025, beta, p1, p2, k, delta, margin)

trial_size_n = ceiling(trial_size_n1) * 2
trial_size_n = trial_size_n/(1 - drop_out_rate)
ceiling(trial_size_n)
```

При использовании [библиотеки TrialSize для расчета объема выборки для non-inferiority двухвыборочного параллельного исследования](https://rdrr.io/cran/TrialSize/src/R/TwoSampleProportion.NIS.R "TwoSampleProportion.NIS.R") мы рассчитали общий объем выборки с учетом непредвиденного 10%-ого выбытия пациентов - 69 человек (70 человек для деления на 2 группы) - аналогичный результат с нашими расчетами по формуле.

3.  Рассчитайте выборку для гипотезы equality для следующего исследования. Мы хотим сравнить новую терапию инфекции, присоединяющейся в больничных условиях у пациентов с ожогами, с золотым стандартом, основываясь на данных, анализируемых с помощью регрессии Кокса. Пусть отношение рисков «золотой стандарт / новая терапия», hazard ratio, HR = 2. Мы предполагаем, что 80% пациентов (d = 0.8) могут столкнуться с этим заболеванием. Соотношения групп терапии равны (p1=p2=0.5).

*Воспользуйтесь следующей формулой:*

$$
n1 = n2 = \frac{(Z_{\frac{\alpha}{2}}+Z_{\beta})^2}{ln(HR)^2p_1p_2d} , n = n_1 + n_2
$$

```{r}
# Задаем указанные параметры для дальнейших расчетов
HR = 2
d = 0.8
p1 = 0.5
p2 = 0.5
Za <- abs(qnorm(alpha / 2, lower.tail = FALSE))
Zb <- abs(qnorm(beta))
```

```{r}
# Расчет объема выборки для одной группы
n1 = ceiling(
    (Za + Zb)^2/((log(HR))^2 * p1 * p2 * d)
)
print(n1)
```

```{r}
# Общий объем выборки для обеих групп
n = n1*2
print(n)
```

```{r}
# Расчет объема выборки с учетом drop-out rate
n_new = ceiling(
    n/(1-drop_out_rate)
)
print(n_new)
```

Рассчетный общий объем выборки - 183 человек. Для более корректного разделения на 2 группы в дальнейшем возьмем 184 человек - по 92 в каждой группе.

```{r}
# Проверим с помощью библиотеки TrialSize
margin = p1 - p2
loghr = log(HR)
trial_size_n1 <- Cox.Equality(alpha, beta, loghr, p1, d)

trial_size_n = ceiling(trial_size_n1) * 2
trial_size_n = trial_size_n/(1 - drop_out_rate)
ceiling(trial_size_n)
```

При использовании [библиотеки TrialSize для исследования с гипотезой equality](https://rdrr.io/cran/TrialSize/src/R/Cox.Equality.R "Cox.Equality.R") мы рассчитали общий объем выборки с учетом непредвиденного 10%-ого выбытия пациентов - 183 человек (184 человек для деления на 2 группы) - аналогичный результат с нашими расчетами по формуле.